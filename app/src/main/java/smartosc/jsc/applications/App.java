/*
 * This source file was generated by the Gradle 'init' task
 */
package smartosc.jsc.applications;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;

import smartosc.jsc.applications.etl.ba_nodes.NodeCommand;
import smartosc.jsc.applications.etl.ba_nodes.Node;
import smartosc.jsc.applications.etl.ba_nodes.NodeFactory;
import smartosc.jsc.applications.etl.ba_nodes.NodeExecutionQueue;

import java.util.List;
import java.util.concurrent.atomic.AtomicInteger;

public class App {
    static ObjectMapper mapper = new ObjectMapper();

    public static void main(String[] args) {
        try {
            JsonNode jsonDataset = mapper.readTree(inputData());
            JsonNode jsonConfig = mapper.readTree(inputConfig());
            JsonNode nodes = jsonConfig.get("nodes");

            AtomicInteger latestId = new AtomicInteger();
            NodeFactory nodeFactory = new NodeFactory();
            NodeExecutionQueue nodeExecutionQueue = new NodeExecutionQueue();

            nodes.forEach(node -> {
                Node newNode = null;
                Integer nodeId = node.get("id").asInt();
                String nodeName = node.get("name").asText();
                String params =  node.get("config").toString();
                JsonNode children = node.get("children");
                JsonNode parent = node.get("parent");

                try {
                    newNode = nodeFactory.createNode(nodeName);
                } catch (Exception e) {
                    throw new RuntimeException(e);
                }

                NodeCommand command = new NodeCommand(nodeId, newNode, params, children, parent, jsonDataset);
                nodeExecutionQueue.addQueue(command);
                latestId.set(nodeId);
            });

            List<JsonNode> nodeResult = nodeExecutionQueue.executeAll();

            if (!nodeResult.get(latestId.get()).isEmpty()) {
                System.out.println(convertDataToJson(nodeResult.get(latestId.get())));
            }

            System.out.println("\nDone!");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    static String convertDataToJson(JsonNode jsonNode) throws JsonProcessingException {
        return mapper.writerWithDefaultPrettyPrinter().writeValueAsString(jsonNode);
    }

    static String inputConfig() {
        return "{\n" +
                "    \"nodes\": {\n" +
                "        \"0\": {\n" +
                "            \"id\": 0,\n" +
                "            \"name\": \"load\",\n" +
                "            \"config\": [],\n" +
                "            \"children\": [1],\n" +
                "            \"parent\": []\n" +
                "        },\n" +
                "        \"1\": {\n" +
                "            \"id\": 1,\n" +
                "            \"name\": \"rename\",\n" +
                "            \"config\": [{\"oldColumn\": \"title\", \"newColumn\": \"name\"}],\n" +
                "            \"children\": [2],\n" +
                "            \"parent\": [0]\n" +
                "        },\n" +
                "        \"2\": {\n" +
                "            \"id\": 2,\n" +
                "            \"name\": \"concat\",\n" +
                "            \"config\": [{\"newColumn\": \"sku_country\", \"columnValue\": \"name,country\"}],\n" +
                "            \"children\": [3],\n" +
                "            \"parent\": [1]\n" +
                "        },\n" +
                "        \"3\": {\n" +
                "            \"id\": 3,\n" +
                "            \"name\": \"remove\",\n" +
                "            \"config\": [{\"columns\": \"image\"}],\n" +
                "            \"children\": [4, 5],\n" +
                "            \"parent\": [2]\n" +
                "        },\n" +
                "        \"4\": {\n" +
                "            \"id\": 4,\n" +
                "            \"name\": \"filter\",\n" +
                "            \"config\": [{\"column\": \"country\", \"operator\": \"=\", \"value\": \"VN\"}],\n" +
                "            \"children\": [6],\n" +
                "            \"parent\": [3]\n" +
                "        },\n" +
                "        \"5\": {\n" +
                "            \"id\": 5,\n" +
                "            \"name\": \"filter\",\n" +
                "            \"config\": [{\"column\": \"category\", \"operator\": \"=\", \"value\": \"Soundbar\"}],\n" +
                "            \"children\": [7],\n" +
                "            \"parent\": [3]\n" +
                "        },\n" +
                "        \"6\": {\n" +
                "            \"id\": 6,\n" +
                "            \"name\": \"add\",\n" +
                "            \"config\": [{\"column\": \"salable\", \"value\": \"Y\"}],\n" +
                "            \"children\": [8],\n" +
                "            \"parent\": [4]\n" +
                "        },\n" +
                "        \"7\": {\n" +
                "            \"id\": 7,\n" +
                "            \"name\": \"add\",\n" +
                "            \"config\": [{\"column\": \"salable\", \"value\": \"N\"}],\n" +
                "            \"children\": [8],\n" +
                "            \"parent\": [5]\n" +
                "        },\n" +
                "        \"8\": {\n" +
                "            \"id\": 8,\n" +
                "            \"name\": \"union\",\n" +
                "            \"config\": [],\n" +
                "            \"children\": [],\n" +
                "            \"parent\": [6, 7]\n" +
                "        }\n" +
                "    }\n" +
                "}";
    }

    static String inputData() {
        return "[ {\n" +
                "  \"id\" : 1,\n" +
                "  \"sku\" : \"EXAM.SKU.01\",\n" +
                "  \"title\" : \"Smart Tivi 4K\",\n" +
                "  \"width\" : 120,\n" +
                "  \"height\" : 40,\n" +
                "  \"category\" : \"TIVI\",\n" +
                "  \"image\" : \"https://lg.com/sku/1\",\n" +
                "  \"country\" : \"VN\"\n" +
                "}, {\n" +
                "  \"id\" : 2,\n" +
                "  \"sku\" : \"EXAM.SKU.02\",\n" +
                "  \"title\" : \"Smart Tivi 4K Untra Width\",\n" +
                "  \"width\" : 120,\n" +
                "  \"height\" : 40,\n" +
                "  \"category\" : \"TIVI\",\n" +
                "  \"image\" : \"https://lg.com/sku/2\",\n" +
                "  \"country\" : \"VN\"\n" +
                "}, {\n" +
                "  \"id\" : 3,\n" +
                "  \"sku\" : \"EXAM.SKU.03\",\n" +
                "  \"title\" : \"Smart Tivi 2K\",\n" +
                "  \"width\" : 120,\n" +
                "  \"height\" : 40,\n" +
                "  \"category\" : \"TIVI\",\n" +
                "  \"image\" : \"https://lg.com/sku/3\",\n" +
                "  \"country\" : \"VN\"\n" +
                "}, {\n" +
                "  \"id\" : 4,\n" +
                "  \"sku\" : \"EXAM.SKU.04\",\n" +
                "  \"title\" : \"Smart Tivi 2K Untra Width\",\n" +
                "  \"width\" : 120,\n" +
                "  \"height\" : 40,\n" +
                "  \"category\" : \"TIVI\",\n" +
                "  \"image\" : \"https://lg.com/sku/4\",\n" +
                "  \"country\" : \"VN\"\n" +
                "}, {\n" +
                "  \"id\" : 5,\n" +
                "  \"sku\" : \"EXAM.SKU.05\",\n" +
                "  \"title\" : \"Smart Tivi 8K\",\n" +
                "  \"width\" : 120,\n" +
                "  \"height\" : 40,\n" +
                "  \"category\" : \"TIVI\",\n" +
                "  \"image\" : \"https://lg.com/sku/5\",\n" +
                "  \"country\" : \"VN\"\n" +
                "}, {\n" +
                "  \"id\" : 6,\n" +
                "  \"sku\" : \"EXAM.SKU.06\",\n" +
                "  \"title\" : \"Smart Tivi 8K Untra Width\",\n" +
                "  \"width\" : 120,\n" +
                "  \"height\" : 40,\n" +
                "  \"category\" : \"TIVI\",\n" +
                "  \"image\" : \"https://lg.com/sku/6\",\n" +
                "  \"country\" : \"VN\"\n" +
                "}, {\n" +
                "  \"id\" : 7,\n" +
                "  \"sku\" : \"EXAM.SKU.07\",\n" +
                "  \"title\" : \"Projector 4K\",\n" +
                "  \"width\" : 20,\n" +
                "  \"height\" : 30,\n" +
                "  \"category\" : \"Projector\",\n" +
                "  \"image\" : \"https://lg.com/sku/7\",\n" +
                "  \"country\" : \"VN\"\n" +
                "}, {\n" +
                "  \"id\" : 8,\n" +
                "  \"sku\" : \"EXAM.SKU.08\",\n" +
                "  \"title\" : \"Projector 4K Untra Width\",\n" +
                "  \"width\" : 20,\n" +
                "  \"height\" : 30,\n" +
                "  \"category\" : \"Projector\",\n" +
                "  \"image\" : \"https://lg.com/sku/8\",\n" +
                "  \"country\" : \"VN\"\n" +
                "}, {\n" +
                "  \"id\" : 9,\n" +
                "  \"sku\" : \"EXAM.SKU.09\",\n" +
                "  \"title\" : \"Projector 2K\",\n" +
                "  \"width\" : 20,\n" +
                "  \"height\" : 30,\n" +
                "  \"category\" : \"Projector\",\n" +
                "  \"image\" : \"https://lg.com/sku/9\",\n" +
                "  \"country\" : \"VN\"\n" +
                "}, {\n" +
                "  \"id\" : 10,\n" +
                "  \"sku\" : \"EXAM.SKU.10\",\n" +
                "  \"title\" : \"Projector 2K Untra Width\",\n" +
                "  \"width\" : 20,\n" +
                "  \"height\" : 30,\n" +
                "  \"category\" : \"Projector\",\n" +
                "  \"image\" : \"https://lg.com/sku/10\",\n" +
                "  \"country\" : \"VN\"\n" +
                "}, {\n" +
                "  \"id\" : 11,\n" +
                "  \"sku\" : \"EXAM.SKU.11\",\n" +
                "  \"title\" : \"Projector 8K\",\n" +
                "  \"width\" : 20,\n" +
                "  \"height\" : 30,\n" +
                "  \"category\" : \"Projector\",\n" +
                "  \"image\" : \"https://lg.com/sku/11\",\n" +
                "  \"country\" : \"VN\"\n" +
                "}, {\n" +
                "  \"id\" : 12,\n" +
                "  \"sku\" : \"EXAM.SKU.12\",\n" +
                "  \"title\" : \"Projector 8K Untra Width\",\n" +
                "  \"width\" : 20,\n" +
                "  \"height\" : 30,\n" +
                "  \"category\" : \"Projector\",\n" +
                "  \"image\" : \"https://lg.com/sku/12\",\n" +
                "  \"country\" : \"VN\"\n" +
                "}, {\n" +
                "  \"id\" : 13,\n" +
                "  \"sku\" : \"EXAM.SKU.13\",\n" +
                "  \"title\" : \"Soundbar Bluetooth A\",\n" +
                "  \"width\" : 140,\n" +
                "  \"height\" : 15,\n" +
                "  \"category\" : \"Soundbar\",\n" +
                "  \"image\" : \"https://lg.com/sku/13\",\n" +
                "  \"country\" : \"UK\"\n" +
                "}, {\n" +
                "  \"id\" : 14,\n" +
                "  \"sku\" : \"EXAM.SKU.14\",\n" +
                "  \"title\" : \"Soundbar Bluetooth A\",\n" +
                "  \"width\" : 140,\n" +
                "  \"height\" : 15,\n" +
                "  \"category\" : \"Soundbar\",\n" +
                "  \"image\" : \"https://lg.com/sku/14\",\n" +
                "  \"country\" : \"UK\"\n" +
                "}, {\n" +
                "  \"id\" : 15,\n" +
                "  \"sku\" : \"EXAM.SKU.15\",\n" +
                "  \"title\" : \"Soundbar Bluetooth A\",\n" +
                "  \"width\" : 140,\n" +
                "  \"height\" : 15,\n" +
                "  \"category\" : \"Soundbar\",\n" +
                "  \"image\" : \"https://lg.com/sku/15\",\n" +
                "  \"country\" : \"UK\"\n" +
                "}, {\n" +
                "  \"id\" : 16,\n" +
                "  \"sku\" : \"EXAM.SKU.16\",\n" +
                "  \"title\" : \"Soundbar Bluetooth A\",\n" +
                "  \"width\" : 140,\n" +
                "  \"height\" : 15,\n" +
                "  \"category\" : \"Soundbar\",\n" +
                "  \"image\" : \"https://lg.com/sku/16\",\n" +
                "  \"country\" : \"UK\"\n" +
                "}, {\n" +
                "  \"id\" : 17,\n" +
                "  \"sku\" : \"EXAM.SKU.17\",\n" +
                "  \"title\" : \"Soundbar Bluetooth A\",\n" +
                "  \"width\" : 140,\n" +
                "  \"height\" : 15,\n" +
                "  \"category\" : \"Soundbar\",\n" +
                "  \"image\" : \"https://lg.com/sku/17\",\n" +
                "  \"country\" : \"VN\"\n" +
                "}, {\n" +
                "  \"id\" : 18,\n" +
                "  \"sku\" : \"EXAM.SKU.18\",\n" +
                "  \"title\" : \"Soundbar Bluetooth A\",\n" +
                "  \"width\" : 140,\n" +
                "  \"height\" : 15,\n" +
                "  \"category\" : \"Soundbar\",\n" +
                "  \"image\" : \"https://lg.com/sku/18\",\n" +
                "  \"country\" : \"VN\"\n" +
                "}, {\n" +
                "  \"id\" : 19,\n" +
                "  \"sku\" : \"EXAM.SKU.19\",\n" +
                "  \"title\" : \"Soundbar Bluetooth A\",\n" +
                "  \"width\" : 140,\n" +
                "  \"height\" : 15,\n" +
                "  \"category\" : \"Soundbar\",\n" +
                "  \"image\" : \"https://lg.com/sku/19\",\n" +
                "  \"country\" : \"VN\"\n" +
                "}, {\n" +
                "  \"id\" : 20,\n" +
                "  \"sku\" : \"EXAM.SKU.20\",\n" +
                "  \"title\" : \"Soundbar Bluetooth A\",\n" +
                "  \"width\" : 140,\n" +
                "  \"height\" : 15,\n" +
                "  \"category\" : \"Soundbar\",\n" +
                "  \"image\" : \"https://lg.com/sku/20\",\n" +
                "  \"country\" : \"VN\"\n" +
                "}, {\n" +
                "  \"id\" : 21,\n" +
                "  \"sku\" : \"EXAM.SKU.21\",\n" +
                "  \"title\" : \"Soundbar Bluetooth A\",\n" +
                "  \"width\" : 140,\n" +
                "  \"height\" : 15,\n" +
                "  \"category\" : \"Soundbar\",\n" +
                "  \"image\" : \"https://lg.com/sku/21\",\n" +
                "  \"country\" : \"VN\"\n" +
                "}, {\n" +
                "  \"id\" : 22,\n" +
                "  \"sku\" : \"EXAM.SKU.22\",\n" +
                "  \"title\" : \"Soundbar Bluetooth A\",\n" +
                "  \"width\" : 140,\n" +
                "  \"height\" : 15,\n" +
                "  \"category\" : \"Soundbar\",\n" +
                "  \"image\" : \"https://lg.com/sku/22\",\n" +
                "  \"country\" : \"VN\"\n" +
                "} ]";
    }
}